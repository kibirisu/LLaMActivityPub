name: Sqlc checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sqlc-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check if commit is a merge commit
        id: check_merge
        run: |
          parents=$(git rev-list --parents -n 1 HEAD | wc -w)
          if [ "$parents" -gt 2 ]; then
            echo "merge=true" >> $GITHUB_OUTPUT
          else
            echo "merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Run build only for merge commits
        if: steps.check_merge.outputs.merge == 'true'
        run: |
          echo "This is a merge commit on main â€” running tests"

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup sqlc
        uses: sqlc-dev/setup-sqlc@v3
        with:
          sqlc-version: '1.30.0'

      - name: Setup postgres
        uses: sqlc-dev/action-setup-postgres@master
        with:
          postgres-version: "16"
        id: postgres

      - name: Sqlc Vet (syntax and semantics)
        run: sqlc vet -f .sqlc.yaml --no-remote

      - name: Sqlc Diff (is generated code up to date)
        run: sqlc diff -f .sqlc.yaml --no-remote
